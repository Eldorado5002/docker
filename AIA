# Multi-stage build for Maven WAR application
# ===== Build Stage =====
FROM maven:3.9.6-eclipse-temurin-8 AS build
WORKDIR /app
# Cache dependencies first
COPY pom.xml .
RUN mvn -B -e -q dependency:go-offline
# Copy source
COPY src ./src
# Package the WAR (skip tests for speed; adjust if you add tests)
RUN mvn -B -q package -DskipTests

# ===== Runtime Stage =====
# Use Tomcat 9 (supports Servlet 4.0) with Java 8 to match compiler target
FROM tomcat:9.0-jdk8-temurin
# Remove default ROOT app
RUN rm -rf /usr/local/tomcat/webapps/ROOT
# Copy built WAR as ROOT.war so it is served at context path /
COPY --from=build /app/target/maven-web-app.war /usr/local/tomcat/webapps/ROOT.war

# Expose internal container port
EXPOSE 8080

# Healthcheck (optional basic HTTP check)
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
  CMD wget -q -O - http://localhost:8080/ || exit 1

# Start Tomcat
CMD ["catalina.sh", "run"]
